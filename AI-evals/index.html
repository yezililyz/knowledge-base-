<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Evals ‚Äî First Principles</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:ital,wght@0,300;0,400;0,500;1,300&family=Instrument+Serif:ital@0;1&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;}
:root{
  --bg:#0A0B0E;
  --surface:#111318;
  --surface2:#1A1D24;
  --border:#22262F;
  --amber:#F5A623;
  --amber-dim:#8C5D12;
  --amber-glow:rgba(245,166,35,0.08);
  --red:#E85D75;
  --teal:#2EC4B6;
  --purple:#9B7FE8;
  --text:#E8E9EC;
  --text-muted:#6B7280;
  --text-dim:#3D4250;
  --mono:'DM Mono',monospace;
  --serif:'Instrument Serif',serif;
  --sans:'DM Sans',sans-serif;
}
html{scroll-behavior:smooth;}
body{background:var(--bg);color:var(--text);font-family:var(--sans);font-size:15px;line-height:1.6;overflow-x:hidden;}

/* GRID BACKGROUND */
body::before{
  content:'';position:fixed;inset:0;
  background-image:linear-gradient(var(--border) 1px,transparent 1px),linear-gradient(90deg,var(--border) 1px,transparent 1px);
  background-size:48px 48px;
  opacity:0.35;pointer-events:none;z-index:0;
}

/* SCANLINE */
body::after{
  content:'';position:fixed;inset:0;
  background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,0.03) 2px,rgba(0,0,0,0.03) 4px);
  pointer-events:none;z-index:0;
}

.wrap{position:relative;z-index:1;max-width:960px;margin:0 auto;padding:0 24px;}

/* NAV */
nav{
  position:sticky;top:0;z-index:100;
  background:rgba(10,11,14,0.92);backdrop-filter:blur(12px);
  border-bottom:1px solid var(--border);
  padding:12px 0;
}
.nav-inner{display:flex;align-items:center;justify-content:space-between;}
.nav-logo{font-family:var(--mono);font-size:12px;color:var(--amber);letter-spacing:0.1em;text-transform:uppercase;}
.nav-steps{display:flex;gap:4px;}
.nav-step{
  font-family:var(--mono);font-size:10px;letter-spacing:0.05em;text-transform:uppercase;
  padding:4px 10px;border-radius:3px;cursor:pointer;
  border:1px solid transparent;color:var(--text-muted);transition:all 0.2s;
}
.nav-step:hover,.nav-step.active{border-color:var(--amber);color:var(--amber);background:var(--amber-glow);}

/* HERO */
.hero{padding:80px 0 60px;}
.hero-tag{
  display:inline-flex;align-items:center;gap:8px;
  font-family:var(--mono);font-size:11px;color:var(--amber);letter-spacing:0.12em;text-transform:uppercase;
  margin-bottom:24px;
}
.hero-tag::before{content:'//';opacity:0.5;}
h1{
  font-family:var(--serif);font-size:clamp(42px,6vw,72px);font-weight:400;
  line-height:1.05;letter-spacing:-0.02em;margin-bottom:16px;
}
h1 em{color:var(--amber);font-style:italic;}
.hero-sub{
  font-size:16px;color:var(--text-muted);max-width:560px;line-height:1.7;
  margin-bottom:40px;
}
.hero-source{
  display:inline-flex;align-items:center;gap:10px;
  background:var(--surface);border:1px solid var(--border);border-radius:6px;
  padding:10px 16px;font-family:var(--mono);font-size:11px;color:var(--text-muted);
}
.hero-source span{color:var(--amber);}

/* PROGRESS BAR */
.progress-bar{
  height:2px;background:var(--border);border-radius:1px;margin:40px 0;
  position:relative;overflow:visible;
}
.progress-fill{
  height:100%;background:var(--amber);border-radius:1px;width:0%;
  transition:width 0.8s cubic-bezier(0.4,0,0.2,1);
}
.progress-label{
  position:absolute;right:0;top:-20px;
  font-family:var(--mono);font-size:10px;color:var(--amber);
}

/* SECTION */
section{padding:64px 0;border-top:1px solid var(--border);}
.sec-number{
  font-family:var(--mono);font-size:11px;color:var(--amber);
  letter-spacing:0.1em;margin-bottom:12px;opacity:0.7;
}
h2{
  font-family:var(--serif);font-size:clamp(28px,4vw,42px);font-weight:400;
  letter-spacing:-0.02em;margin-bottom:8px;
}
.sec-sub{font-size:14px;color:var(--text-muted);margin-bottom:40px;max-width:600px;}

/* FIRST PRINCIPLES CARDS */
.fp-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:24px;}
.fp-card{
  background:var(--surface);border:1px solid var(--border);border-radius:8px;
  padding:24px;cursor:pointer;transition:all 0.25s;position:relative;overflow:hidden;
}
.fp-card::before{
  content:'';position:absolute;top:0;left:0;right:0;height:2px;
  background:var(--amber);transform:scaleX(0);transform-origin:left;transition:transform 0.3s;
}
.fp-card:hover,.fp-card.open{border-color:var(--amber);background:var(--amber-glow);}
.fp-card:hover::before,.fp-card.open::before{transform:scaleX(1);}
.fp-q{
  font-family:var(--mono);font-size:11px;color:var(--amber);
  letter-spacing:0.08em;text-transform:uppercase;margin-bottom:10px;
}
.fp-title{font-family:var(--serif);font-size:20px;margin-bottom:8px;}
.fp-body{font-size:13px;color:var(--text-muted);line-height:1.65;
  max-height:0;overflow:hidden;transition:max-height 0.4s ease,margin-top 0.3s;}
.fp-card.open .fp-body{max-height:200px;margin-top:12px;}
.fp-toggle{
  position:absolute;top:20px;right:20px;
  font-family:var(--mono);font-size:16px;color:var(--text-dim);transition:all 0.3s;
}
.fp-card.open .fp-toggle{color:var(--amber);transform:rotate(45deg);}

/* RISK TABLE */
.risk-table{width:100%;border-collapse:collapse;margin:24px 0;}
.risk-table th{
  font-family:var(--mono);font-size:10px;letter-spacing:0.1em;text-transform:uppercase;
  color:var(--text-muted);padding:8px 16px;text-align:left;
  border-bottom:1px solid var(--border);
}
.risk-table td{
  padding:12px 16px;border-bottom:1px solid var(--border);font-size:13px;
  vertical-align:top;
}
.risk-table tr:last-child td{border-bottom:none;}
.risk-table tr:hover td{background:var(--surface2);}
.tag{
  display:inline-block;font-family:var(--mono);font-size:10px;
  padding:2px 8px;border-radius:3px;letter-spacing:0.05em;font-weight:500;
}
.tag-p0{background:rgba(232,93,117,0.15);color:var(--red);border:1px solid rgba(232,93,117,0.3);}
.tag-p1{background:rgba(245,166,35,0.12);color:var(--amber);border:1px solid rgba(245,166,35,0.25);}
.tag-p2{background:rgba(46,196,182,0.1);color:var(--teal);border:1px solid rgba(46,196,182,0.2);}

/* PYRAMID */
.pyramid-wrap{position:relative;margin:32px 0;}
.pyramid-row{
  display:flex;align-items:center;margin-bottom:8px;cursor:pointer;
}
.pyramid-bar{
  height:52px;display:flex;align-items:center;justify-content:center;
  border-radius:4px;font-size:13px;font-weight:500;transition:all 0.2s;
  position:relative;flex-shrink:0;
}
.pyramid-bar:hover{filter:brightness(1.15);}
.pyramid-info{
  margin-left:16px;flex:1;
  font-size:12px;color:var(--text-muted);line-height:1.5;
  max-width:0;overflow:hidden;white-space:nowrap;transition:max-width 0.4s,opacity 0.3s;opacity:0;
}
.pyramid-row:hover .pyramid-info,.pyramid-row.selected .pyramid-info{max-width:400px;opacity:1;white-space:normal;}
.p-row-1 .pyramid-bar{width:100%;background:rgba(232,93,117,0.2);border:1px solid rgba(232,93,117,0.4);color:var(--red);}
.p-row-2 .pyramid-bar{width:84%;background:rgba(245,166,35,0.15);border:1px solid rgba(245,166,35,0.3);color:var(--amber);}
.p-row-3 .pyramid-bar{width:68%;background:rgba(155,127,232,0.15);border:1px solid rgba(155,127,232,0.3);color:var(--purple);}
.p-row-4 .pyramid-bar{width:52%;background:rgba(46,196,182,0.12);border:1px solid rgba(46,196,182,0.25);color:var(--teal);}

/* METRICS BUILDER */
.metric-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin:24px 0;}
.metric-card{
  background:var(--surface);border:1px solid var(--border);border-radius:8px;
  padding:20px;transition:all 0.2s;position:relative;
}
.metric-name{font-family:var(--mono);font-size:11px;color:var(--text-muted);letter-spacing:0.08em;text-transform:uppercase;margin-bottom:8px;}
.metric-val{font-family:var(--mono);font-size:28px;color:var(--text);margin-bottom:4px;}
.metric-threshold{font-size:11px;color:var(--text-muted);}
.metric-status{
  position:absolute;top:16px;right:16px;
  width:8px;height:8px;border-radius:50%;
}
.status-ok{background:var(--teal);box-shadow:0 0 8px var(--teal);}
.status-warn{background:var(--amber);box-shadow:0 0 8px var(--amber);animation:pulse 2s infinite;}
.status-crit{background:var(--red);box-shadow:0 0 8px var(--red);animation:pulse 1s infinite;}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:0.4;}}

/* SLIDER */
.slider-row{display:flex;align-items:center;gap:16px;margin:12px 0;}
.slider-label{font-family:var(--mono);font-size:11px;color:var(--text-muted);width:160px;flex-shrink:0;}
input[type=range]{
  flex:1;-webkit-appearance:none;height:3px;
  background:var(--border);border-radius:2px;outline:none;cursor:pointer;
}
input[type=range]::-webkit-slider-thumb{
  -webkit-appearance:none;width:16px;height:16px;border-radius:50%;
  background:var(--amber);border:2px solid var(--bg);cursor:pointer;
  box-shadow:0 0 8px rgba(245,166,35,0.5);
}
.slider-val{font-family:var(--mono);font-size:13px;color:var(--amber);width:48px;text-align:right;}

/* EVAL TYPES */
.eval-tabs{display:flex;gap:0;border:1px solid var(--border);border-radius:6px;overflow:hidden;margin-bottom:24px;width:fit-content;}
.eval-tab{
  padding:10px 24px;font-family:var(--mono);font-size:11px;letter-spacing:0.08em;
  text-transform:uppercase;cursor:pointer;color:var(--text-muted);
  background:transparent;border:none;transition:all 0.2s;
}
.eval-tab:not(:last-child){border-right:1px solid var(--border);}
.eval-tab.active{background:var(--amber);color:#0A0B0E;font-weight:500;}
.eval-tab:hover:not(.active){background:var(--surface2);color:var(--text);}
.eval-panel{display:none;}
.eval-panel.active{display:block;}
.code-block{
  background:var(--surface);border:1px solid var(--border);border-radius:6px;
  padding:20px 24px;font-family:var(--mono);font-size:12px;line-height:1.8;
  color:#A8B0BF;margin:16px 0;overflow-x:auto;
}
.code-block .kw{color:var(--purple);}
.code-block .str{color:var(--teal);}
.code-block .cm{color:var(--text-dim);font-style:italic;}
.code-block .num{color:var(--amber);}
.code-block .fn{color:var(--red);}

/* FLYWHEEL */
.flywheel-wrap{position:relative;height:420px;margin:32px 0;}
.flywheel-center{
  position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
  width:120px;height:120px;border-radius:50%;
  background:var(--surface2);border:2px solid var(--amber);
  display:flex;align-items:center;justify-content:center;text-align:center;
  font-family:var(--mono);font-size:10px;color:var(--amber);letter-spacing:0.06em;text-transform:uppercase;line-height:1.4;
  z-index:5;
}
.flywheel-node{
  position:absolute;width:100px;height:72px;
  background:var(--surface);border:1px solid var(--border);border-radius:6px;
  display:flex;align-items:center;justify-content:center;text-align:center;
  font-size:11px;color:var(--text-muted);padding:8px;line-height:1.4;
  cursor:pointer;transition:all 0.25s;z-index:4;
}
.flywheel-node:hover{border-color:var(--amber);color:var(--text);background:var(--amber-glow);}
.flywheel-node .node-num{font-family:var(--mono);font-size:10px;color:var(--amber);display:block;margin-bottom:4px;}
/* positions */
.fn-1{top:10px;left:50%;transform:translateX(-50%);}
.fn-2{top:20%;right:8%;}
.fn-3{bottom:20%;right:8%;}
.fn-4{bottom:10px;left:50%;transform:translateX(-50%);}
.fn-5{bottom:20%;left:8%;}
.fn-6{top:20%;left:8%;}
/* arrows using SVG overlay */
.flywheel-svg{position:absolute;inset:0;width:100%;height:100%;pointer-events:none;}

/* DATASET VIZ */
.dataset-bars{display:flex;flex-direction:column;gap:10px;margin:24px 0;}
.ds-row{display:flex;align-items:center;gap:12px;}
.ds-label{font-family:var(--mono);font-size:11px;color:var(--text-muted);width:200px;flex-shrink:0;}
.ds-bar-wrap{flex:1;background:var(--border);border-radius:3px;height:28px;overflow:hidden;position:relative;}
.ds-bar{
  height:100%;display:flex;align-items:center;padding:0 12px;
  font-family:var(--mono);font-size:11px;color:var(--bg);font-weight:500;
  transition:width 1.2s cubic-bezier(0.4,0,0.2,1);width:0%;border-radius:3px;
}
.ds-count{font-family:var(--mono);font-size:11px;color:var(--text-muted);width:60px;text-align:right;}
.ds-tag{width:32px;text-align:center;}

/* CHECKLIST */
.checklist{display:flex;flex-direction:column;gap:10px;margin:24px 0;}
.check-item{
  display:flex;align-items:flex-start;gap:14px;
  background:var(--surface);border:1px solid var(--border);border-radius:6px;
  padding:16px;cursor:pointer;transition:all 0.2s;
}
.check-item:hover{border-color:var(--text-dim);}
.check-item.done{border-color:var(--teal);background:rgba(46,196,182,0.05);}
.check-box{
  width:20px;height:20px;border-radius:4px;border:1.5px solid var(--border);
  display:flex;align-items:center;justify-content:center;flex-shrink:0;
  margin-top:1px;transition:all 0.2s;font-size:11px;
}
.check-item.done .check-box{border-color:var(--teal);background:var(--teal);color:var(--bg);}
.check-title{font-size:13px;font-weight:500;margin-bottom:2px;}
.check-desc{font-size:12px;color:var(--text-muted);}

/* GATE VIZ */
.gate-flow{display:flex;align-items:center;gap:0;margin:24px 0;overflow-x:auto;padding-bottom:8px;}
.gate-node{
  display:flex;flex-direction:column;align-items:center;gap:8px;flex-shrink:0;
}
.gate-box{
  background:var(--surface);border:1px solid var(--border);border-radius:6px;
  padding:14px 18px;text-align:center;min-width:110px;
}
.gate-box.blocker{border-color:var(--red);}
.gate-box.monitor{border-color:var(--amber);}
.gate-box.pass{border-color:var(--teal);}
.gate-label{font-family:var(--mono);font-size:10px;letter-spacing:0.08em;text-transform:uppercase;margin-bottom:4px;}
.gate-label.red{color:var(--red);}
.gate-label.amber{color:var(--amber);}
.gate-label.green{color:var(--teal);}
.gate-thresh{font-size:11px;color:var(--text-muted);}
.gate-arrow{
  padding:0 8px;color:var(--text-dim);font-size:20px;flex-shrink:0;
  font-family:var(--mono);
}

/* QUOTE */
.callout{
  border-left:2px solid var(--amber);padding:20px 24px;
  background:var(--amber-glow);border-radius:0 6px 6px 0;margin:24px 0;
}
.callout-label{font-family:var(--mono);font-size:10px;color:var(--amber);letter-spacing:0.1em;text-transform:uppercase;margin-bottom:8px;}
.callout p{font-size:14px;color:var(--text-muted);line-height:1.7;}
.callout strong{color:var(--text);}

/* FOOTER */
footer{
  padding:48px 0;border-top:1px solid var(--border);
  text-align:center;font-family:var(--mono);font-size:11px;color:var(--text-dim);
}

/* RESPONSIVE */
@media(max-width:640px){
  .fp-grid{grid-template-columns:1fr;}
  .metric-grid{grid-template-columns:1fr 1fr;}
  .nav-steps{display:none;}
  .flywheel-wrap{height:320px;}
  .flywheel-node{width:80px;height:60px;font-size:10px;}
}

/* ANIMATIONS */
@keyframes fadeUp{from{opacity:0;transform:translateY(16px);}to{opacity:1;transform:translateY(0);}}
.animate{opacity:0;animation:fadeUp 0.5s ease forwards;}
</style>
</head>
<body>

<nav>
  <div class="wrap nav-inner">
    <div class="nav-logo">AI Evals // Field Guide</div>
    <div class="nav-steps">
      <div class="nav-step active" onclick="scrollTo(0)">Principles</div>
      <div class="nav-step" onclick="document.getElementById('s2').scrollIntoView({behavior:'smooth'})">Risk Map</div>
      <div class="nav-step" onclick="document.getElementById('s3').scrollIntoView({behavior:'smooth'})">Metrics</div>
      <div class="nav-step" onclick="document.getElementById('s4').scrollIntoView({behavior:'smooth'})">Dataset</div>
      <div class="nav-step" onclick="document.getElementById('s5').scrollIntoView({behavior:'smooth'})">Eval Types</div>
      <div class="nav-step" onclick="document.getElementById('s6').scrollIntoView({behavior:'smooth'})">Flywheel</div>
      <div class="nav-step" onclick="document.getElementById('s7').scrollIntoView({behavior:'smooth'})">Build Yours</div>
    </div>
  </div>
</nav>

<div class="wrap">

<!-- HERO -->
<div class="hero animate">
  <div class="hero-tag">First Principles Guide</div>
  <h1>How to design<br><em>AI Evals</em><br>that actually work</h1>
  <p class="hero-sub">Most teams build evals after something breaks. This guide teaches you how to derive an eval framework from first principles ‚Äî before you write a single prompt.</p>
  <div class="hero-source">
    Case study: <span>INDmoney Mind</span> ‚Äî AI Stock Research Assistant (India)
  </div>
</div>

<div class="progress-bar">
  <div class="progress-fill" id="progress"></div>
  <div class="progress-label" id="progress-label">0% complete</div>
</div>

<!-- S1: FIRST PRINCIPLES -->
<section id="s1">
  <div class="sec-number">01 ‚Äî WHY</div>
  <h2>Start from the question:<br>What breaks if this is wrong?</h2>
  <p class="sec-sub">Before choosing metrics, map the failure modes. Every domain has different stakes. Your eval framework must reflect them.</p>

  <div class="fp-grid">
    <div class="fp-card" onclick="toggleFP(this)">
      <div class="fp-q">Principle 01</div>
      <div class="fp-title">Evals = stakes √ó scale</div>
      <div class="fp-toggle">+</div>
      <div class="fp-body">The higher the stakes and the larger the scale, the more rigorous your evals must be. A stock research AI that reaches 10M users and influences financial decisions demands near-zero tolerance for compliance failures ‚Äî far tighter than a recipe recommender. <strong>First ask: what's the cost of a single bad output?</strong></div>
    </div>
    <div class="fp-card" onclick="toggleFP(this)">
      <div class="fp-q">Principle 02</div>
      <div class="fp-title">You can't measure what you haven't defined</div>
      <div class="fp-toggle">+</div>
      <div class="fp-body">Most teams write prompts, ship, then complain about quality. The right order: <strong>define "good" before you build</strong>. For INDmoney, "good" meant: factually accurate, compliant with SEBI, balanced, and mobile-readable. Each of these can be measured separately.</div>
    </div>
    <div class="fp-card" onclick="toggleFP(this)">
      <div class="fp-q">Principle 03</div>
      <div class="fp-title">Evals are a product, not a script</div>
      <div class="fp-toggle">+</div>
      <div class="fp-body">A single eval script is a snapshot. A living eval system is infrastructure. <strong>Your test dataset needs governance</strong>: weekly additions from production failures, monthly data refreshes, and pre-release human review. Build for maintenance from day one.</div>
    </div>
    <div class="fp-card" onclick="toggleFP(this)">
      <div class="fp-q">Principle 04</div>
      <div class="fp-title">Different signals need different detectors</div>
      <div class="fp-toggle">+</div>
      <div class="fp-body">No single evaluation method catches everything. Rule-based checks are cheap and deterministic (great for compliance). LLM-as-judge is flexible but noisy (great for tone and balance). Human eval is expensive but ground truth. <strong>Use all three in a layered stack.</strong></div>
    </div>
    <div class="fp-card" onclick="toggleFP(this)">
      <div class="fp-q">Principle 05</div>
      <div class="fp-title">Offline ‚â† online performance</div>
      <div class="fp-toggle">+</div>
      <div class="fp-body">Passing a pre-deploy test suite doesn't mean you're safe in production. Real users ask things your test set never imagined. You need both gates: <strong>offline evals to block regressions</strong> and <strong>online evals to catch emergence</strong> ‚Äî novel failure modes that only appear at production scale.</div>
    </div>
    <div class="fp-card" onclick="toggleFP(this)">
      <div class="fp-q">Principle 06</div>
      <div class="fp-title">The flywheel: production feeds the test set</div>
      <div class="fp-toggle">+</div>
      <div class="fp-body">Your best test cases come from real failures. Every low-rated response, every compliance violation, every edge case from production is a <strong>gift to your eval dataset</strong>. The teams that improve fastest are the ones who close this loop systematically ‚Äî not quarterly, but weekly.</div>
    </div>
  </div>

  <div class="callout">
    <div class="callout-label">INDmoney rationale</div>
    <p>"One viral screenshot of bad AI advice could damage brand reputation." ‚Äî The team understood that in fintech, <strong>trust is the product</strong>. The eval framework wasn't bureaucracy ‚Äî it was brand protection at scale.</p>
  </div>
</section>

<!-- S2: RISK MAP -->
<section id="s2">
  <div class="sec-number">02 ‚Äî WHAT CAN GO WRONG</div>
  <h2>Map your failure modes<br>before choosing metrics</h2>
  <p class="sec-sub">Hover each layer to understand what breaks and why it matters. Severity flows from regulatory risk down to experience degradation.</p>

  <div class="pyramid-wrap">
    <div class="pyramid-row p-row-1" onclick="selectRow(this)">
      <div class="pyramid-bar">‚öñÔ∏è Compliance Failures</div>
      <div class="pyramid-info"><strong>Regulatory / Legal risk.</strong> In INDmoney's case: crossing from "analysis" to "recommendation" violates SEBI rules for unlicensed advice. Zero tolerance ‚Äî one failure triggers immediate rollback.</div>
    </div>
    <div class="pyramid-row p-row-2" onclick="selectRow(this)">
      <div class="pyramid-bar">üéØ Factual Errors</div>
      <div class="pyramid-info"><strong>Trust destruction.</strong> A hallucinated P/E ratio or wrong earnings number can cause a real financial loss. Users will never trust the product again. Target: ‚â•98% accuracy, with &lt;95% being a P0 incident.</div>
    </div>
    <div class="pyramid-row p-row-3" onclick="selectRow(this)">
      <div class="pyramid-bar">üîç Groundedness / Hallucination</div>
      <div class="pyramid-info"><strong>Credibility erosion.</strong> Claims not supported by retrieved context ‚Äî the model "invents" insights. Measurable with NLI models. Target: &lt;2% hallucination rate. Above 5% is a P0 issue.</div>
    </div>
    <div class="pyramid-row p-row-4" onclick="selectRow(this)">
      <div class="pyramid-bar">üì± Quality / UX Failures</div>
      <div class="pyramid-info"><strong>Experience degradation.</strong> Irrelevant, unbalanced, slow, or poorly structured responses. Users stop using the feature. Measured via thumbs-up rates, session abandonment, and LLM-as-judge scores.</div>
    </div>
  </div>

  <table class="risk-table">
    <thead>
      <tr>
        <th>Failure Mode</th>
        <th>Detection Method</th>
        <th>Threshold</th>
        <th>Priority</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>Gives buy/sell advice</td>
        <td>Regex + keyword scan</td>
        <td>100% block</td>
        <td><span class="tag tag-p0">P0</span></td>
        <td>Immediate rollback + alert</td>
      </tr>
      <tr>
        <td>Wrong numerical facts</td>
        <td>NER extraction + source compare</td>
        <td>‚â•98% accuracy</td>
        <td><span class="tag tag-p0">P0</span></td>
        <td>Block if &lt;95%</td>
      </tr>
      <tr>
        <td>Hallucinated claims</td>
        <td>NLI model grounding check</td>
        <td>&lt;2% rate</td>
        <td><span class="tag tag-p0">P0</span></td>
        <td>Block if &gt;5%</td>
      </tr>
      <tr>
        <td>Irrelevant response</td>
        <td>LLM-as-judge relevance (1-5)</td>
        <td>‚â•4.0/5 avg</td>
        <td><span class="tag tag-p1">P1</span></td>
        <td>Investigate prompt</td>
      </tr>
      <tr>
        <td>One-sided analysis</td>
        <td>LLM-as-judge balance (1-5)</td>
        <td>‚â•3.5/5 avg</td>
        <td><span class="tag tag-p1">P1</span></td>
        <td>Prompt tuning</td>
      </tr>
      <tr>
        <td>Slow responses</td>
        <td>APM latency monitoring</td>
        <td>P95 &lt;5s</td>
        <td><span class="tag tag-p2">P2</span></td>
        <td>Optimize RAG pipeline</td>
      </tr>
    </tbody>
  </table>
</section>

<!-- S3: METRICS BUILDER -->
<section id="s3">
  <div class="sec-number">03 ‚Äî DECIDE YOUR METRICS</div>
  <h2>Metrics simulator</h2>
  <p class="sec-sub">Adjust the sliders to see how metric changes affect system status. This mirrors what your eval dashboard should look like in production.</p>

  <div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:28px;margin-bottom:24px;">
    <div class="slider-row">
      <div class="slider-label">Numerical Accuracy</div>
      <input type="range" min="85" max="100" value="98" id="sl-accuracy" oninput="updateMetrics()">
      <div class="slider-val" id="sv-accuracy">98%</div>
    </div>
    <div class="slider-row">
      <div class="slider-label">Compliance Pass Rate</div>
      <input type="range" min="95" max="100" step="0.1" value="100" id="sl-compliance" oninput="updateMetrics()">
      <div class="slider-val" id="sv-compliance">100%</div>
    </div>
    <div class="slider-row">
      <div class="slider-label">Hallucination Rate</div>
      <input type="range" min="0" max="10" step="0.1" value="1.2" id="sl-halluc" oninput="updateMetrics()">
      <div class="slider-val" id="sv-halluc">1.2%</div>
    </div>
    <div class="slider-row">
      <div class="slider-label">P95 Latency (s)</div>
      <input type="range" min="0.5" max="8" step="0.1" value="2.1" id="sl-latency" oninput="updateMetrics()">
      <div class="slider-val" id="sv-latency">2.1s</div>
    </div>
    <div class="slider-row">
      <div class="slider-label">User Satisfaction</div>
      <input type="range" min="50" max="100" value="83" id="sl-sat" oninput="updateMetrics()">
      <div class="slider-val" id="sv-sat">83%</div>
    </div>
  </div>

  <div class="metric-grid">
    <div class="metric-card" id="mc-accuracy">
      <div class="metric-status status-ok" id="ms-accuracy"></div>
      <div class="metric-name">Num. Accuracy</div>
      <div class="metric-val" id="mv-accuracy">98%</div>
      <div class="metric-threshold">Target ‚â•98% ¬∑ Block &lt;95%</div>
    </div>
    <div class="metric-card" id="mc-compliance">
      <div class="metric-status status-ok" id="ms-compliance"></div>
      <div class="metric-name">Compliance</div>
      <div class="metric-val" id="mv-compliance">100%</div>
      <div class="metric-threshold">Target 100% ¬∑ Alert &lt;99.5%</div>
    </div>
    <div class="metric-card" id="mc-halluc">
      <div class="metric-status status-ok" id="ms-halluc"></div>
      <div class="metric-name">Hallucination</div>
      <div class="metric-val" id="mv-halluc">1.2%</div>
      <div class="metric-threshold">Target &lt;2% ¬∑ Block &gt;5%</div>
    </div>
    <div class="metric-card" id="mc-latency">
      <div class="metric-status status-ok" id="ms-latency"></div>
      <div class="metric-name">P95 Latency</div>
      <div class="metric-val" id="mv-latency">2.1s</div>
      <div class="metric-threshold">Target &lt;5s ¬∑ Optimize &gt;3s</div>
    </div>
    <div class="metric-card" id="mc-sat">
      <div class="metric-status status-ok" id="ms-sat"></div>
      <div class="metric-name">User Satisfaction</div>
      <div class="metric-val" id="mv-sat">83%</div>
      <div class="metric-threshold">Target ‚â•80% ¬∑ Investigate &lt;70%</div>
    </div>
    <div class="metric-card" style="display:flex;align-items:center;justify-content:center;">
      <div id="deploy-gate" style="text-align:center;">
        <div style="font-family:var(--mono);font-size:10px;letter-spacing:0.1em;text-transform:uppercase;color:var(--teal);margin-bottom:8px;">Deploy Gate</div>
        <div style="font-size:24px;" id="deploy-icon">‚úì</div>
        <div style="font-family:var(--mono);font-size:12px;color:var(--teal);margin-top:6px;" id="deploy-text">CLEARED</div>
      </div>
    </div>
  </div>
</section>

<!-- S4: DATASET -->
<section id="s4">
  <div class="sec-number">04 ‚Äî BUILD YOUR DATASET</div>
  <h2>Test dataset composition<br>matters as much as the tests</h2>
  <p class="sec-sub">INDmoney targets 500+ test cases. The distribution isn't random ‚Äî it reflects risk priority. P0 categories get the most coverage. Click the bars to explore.</p>

  <div class="dataset-bars" id="dataset-bars">
    <!-- filled by JS -->
  </div>

  <div class="callout" style="margin-top:32px;">
    <div class="callout-label">How to collect test cases</div>
    <p>
      <strong>Production mining</strong> ‚Äî sample real user queries from logs (anonymized), prioritize low-rated ones.<br><br>
      <strong>Expert curation</strong> ‚Äî work with domain experts to build "gold standard" cases covering known tricky scenarios.<br><br>
      <strong>Synthetic generation</strong> ‚Äî use an LLM to generate variations and adversarial prompts. Red-team your own system.
    </p>
  </div>
</section>

<!-- S5: EVAL TYPES -->
<section id="s5">
  <div class="sec-number">05 ‚Äî EVAL ARCHITECTURE</div>
  <h2>Three types of evaluators,<br>used in layers</h2>
  <p class="sec-sub">Each method has a different cost, speed, and confidence profile. You need all three working together.</p>

  <div class="eval-tabs">
    <button class="eval-tab active" onclick="switchTab('auto')">Automated / Rules</button>
    <button class="eval-tab" onclick="switchTab('llm')">LLM-as-Judge</button>
    <button class="eval-tab" onclick="switchTab('human')">Human Eval</button>
  </div>

  <div class="eval-panel active" id="tab-auto">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px;">
      <div style="background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:16px;">
        <div style="font-family:var(--mono);font-size:10px;color:var(--teal);letter-spacing:0.1em;text-transform:uppercase;margin-bottom:8px;">When to use</div>
        <div style="font-size:13px;color:var(--text-muted);line-height:1.7;">Deterministic, binary checks. Things that are either correct or not. Runs on every single response at near-zero cost.</div>
      </div>
      <div style="background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:16px;">
        <div style="font-family:var(--mono);font-size:10px;color:var(--red);letter-spacing:0.1em;text-transform:uppercase;margin-bottom:8px;">Limitation</div>
        <div style="font-size:13px;color:var(--text-muted);line-height:1.7;">Cannot assess nuance, tone, or correctness of reasoning. A response can pass all rules and still be unhelpful.</div>
      </div>
    </div>
    <div class="code-block">
<span class="cm"># Compliance checker ‚Äî scans for prohibited patterns</span>
<span class="kw">def</span> <span class="fn">check_compliance</span>(response: str) ‚Üí dict:
    prohibited = [
        <span class="str">"you should buy"</span>, <span class="str">"I recommend"</span>, 
        <span class="str">"guaranteed"</span>, <span class="str">"sure shot"</span>,
        <span class="str">"definitely buy"</span>, <span class="str">"will go up"</span>
    ]
    violations = [p <span class="kw">for</span> p <span class="kw">in</span> prohibited <span class="kw">if</span> p.lower() <span class="kw">in</span> response.lower()]
    <span class="kw">return</span> {
        <span class="str">"passed"</span>: len(violations) == <span class="num">0</span>,
        <span class="str">"violations"</span>: violations,
        <span class="str">"action"</span>: <span class="str">"BLOCK"</span> <span class="kw">if</span> violations <span class="kw">else</span> <span class="str">"PASS"</span>
    }

<span class="cm"># Factual accuracy ‚Äî compare extracted numbers to source data</span>
<span class="kw">def</span> <span class="fn">check_numerical_accuracy</span>(response: str, source_data: dict) ‚Üí float:
    extracted = <span class="fn">extract_numbers_with_context</span>(response)  <span class="cm"># NER+regex</span>
    correct = <span class="num">0</span>
    <span class="kw">for</span> claim <span class="kw">in</span> extracted:
        expected = source_data.get(claim[<span class="str">'field'</span>])
        <span class="kw">if</span> expected <span class="kw">and</span> <span class="fn">values_match</span>(claim[<span class="str">'value'</span>], expected):
            correct += <span class="num">1</span>
    <span class="kw">return</span> correct / len(extracted) <span class="kw">if</span> extracted <span class="kw">else</span> <span class="num">1.0</span>
    </div>
  </div>

  <div class="eval-panel" id="tab-llm">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px;">
      <div style="background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:16px;">
        <div style="font-family:var(--mono);font-size:10px;color:var(--teal);letter-spacing:0.1em;text-transform:uppercase;margin-bottom:8px;">When to use</div>
        <div style="font-size:13px;color:var(--text-muted);line-height:1.7;">Subjective quality signals: relevance, tone, balance. Cheaper than human eval. Run on 1-5% sampled production traffic and on your full offline test set.</div>
      </div>
      <div style="background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:16px;">
        <div style="font-family:var(--mono);font-size:10px;color:var(--red);letter-spacing:0.1em;text-transform:uppercase;margin-bottom:8px;">Limitation</div>
        <div style="font-size:13px;color:var(--text-muted);line-height:1.7;">Biased by judge model's own preferences. Calibrate regularly against human ratings. Don't use for factual accuracy ‚Äî use rules for that.</div>
      </div>
    </div>
    <div class="code-block">
<span class="cm"># LLM-as-judge for relevance and balance</span>
JUDGE_PROMPT = <span class="str">"""
You are evaluating a stock analysis AI response.
Rate the following on a 1-5 scale:

RELEVANCE: Does the response directly address what the user asked?
BALANCE: Does it present both bullish and bearish perspectives?
TONE: Is it professional, clear, and appropriately confident?

User question: {question}
AI response: {response}

Return JSON only:
{"relevance": N, "balance": N, "tone": N, "reasoning": "..."}
"""</span>

<span class="kw">def</span> <span class="fn">llm_judge</span>(question: str, response: str) ‚Üí dict:
    result = <span class="fn">call_gpt4</span>(JUDGE_PROMPT.<span class="fn">format</span>(
        question=question, response=response
    ))
    scores = json.<span class="fn">loads</span>(result)
    <span class="kw">return</span> {
        <span class="str">"passed"</span>: scores[<span class="str">"relevance"</span>] >= <span class="num">4.0</span> <span class="kw">and</span> scores[<span class="str">"balance"</span>] >= <span class="num">3.5</span>,
        **scores
    }
    </div>
  </div>

  <div class="eval-panel" id="tab-human">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px;">
      <div style="background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:16px;">
        <div style="font-family:var(--mono);font-size:10px;color:var(--teal);letter-spacing:0.1em;text-transform:uppercase;margin-bottom:8px;">When to use</div>
        <div style="font-size:13px;color:var(--text-muted);line-height:1.7;">New feature launches, quarterly audits, calibrating the LLM judge, and any time automated metrics decline unexpectedly. This is ground truth ‚Äî expensive but irreplaceable.</div>
      </div>
      <div style="background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:16px;">
        <div style="font-family:var(--mono);font-size:10px;color:var(--red);letter-spacing:0.1em;text-transform:uppercase;margin-bottom:8px;">Limitation</div>
        <div style="font-size:13px;color:var(--text-muted);line-height:1.7;">Slow, expensive, and can't run at scale. Reserve for cases where automated systems disagree or when you're setting calibration baselines.</div>
      </div>
    </div>
    <table class="risk-table">
      <thead><tr><th>Dimension</th><th>Question to rater</th><th>Scale</th><th>Hard fail?</th></tr></thead>
      <tbody>
        <tr><td>Accuracy</td><td>Is the information factually correct?</td><td>1‚Äì5</td><td>No</td></tr>
        <tr><td>Helpfulness</td><td>Would this help a user make an informed decision?</td><td>1‚Äì5</td><td>No</td></tr>
        <tr><td>Trust</td><td>Would you trust this if you were investing?</td><td>1‚Äì5</td><td>No</td></tr>
        <tr><td>Compliance</td><td>Does it avoid giving direct investment advice?</td><td>Pass/Fail</td><td><strong>Yes</strong></td></tr>
        <tr><td>Shareable?</td><td>Would you share this response with a friend?</td><td>Yes/No</td><td>No</td></tr>
      </tbody>
    </table>
  </div>

  <!-- Deploy gates -->
  <div style="margin-top:40px;">
    <div class="sec-number" style="margin-bottom:16px;">Deployment gates</div>
    <div class="gate-flow">
      <div class="gate-node">
        <div class="gate-box">
          <div style="font-size:20px;margin-bottom:6px;">üíª</div>
          <div class="gate-thresh">Code change<br>or prompt edit</div>
        </div>
      </div>
      <div class="gate-arrow">‚Üí</div>
      <div class="gate-node">
        <div class="gate-box blocker">
          <div class="gate-label red">Smoke Test</div>
          <div class="gate-thresh">50 cases<br>BLOCKS deploy</div>
        </div>
      </div>
      <div class="gate-arrow">‚Üí</div>
      <div class="gate-node">
        <div class="gate-box blocker">
          <div class="gate-label red">Compliance Gate</div>
          <div class="gate-thresh">‚â•99.5% pass<br>BLOCKS deploy</div>
        </div>
      </div>
      <div class="gate-arrow">‚Üí</div>
      <div class="gate-node">
        <div class="gate-box blocker">
          <div class="gate-label red">Accuracy Gate</div>
          <div class="gate-thresh">‚â•95% accuracy<br>BLOCKS deploy</div>
        </div>
      </div>
      <div class="gate-arrow">‚Üí</div>
      <div class="gate-node">
        <div class="gate-box pass">
          <div class="gate-label green">Staged Rollout</div>
          <div class="gate-thresh">10% allocation<br>Monitor 24h</div>
        </div>
      </div>
      <div class="gate-arrow">‚Üí</div>
      <div class="gate-node">
        <div class="gate-box" style="border-color:var(--purple);">
          <div class="gate-label" style="color:var(--purple);">Full Deploy</div>
          <div class="gate-thresh">Nightly regression<br>continues</div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- S6: FLYWHEEL -->
<section id="s6">
  <div class="sec-number">06 ‚Äî CONTINUOUS IMPROVEMENT</div>
  <h2>The eval flywheel:<br>production feeds itself</h2>
  <p class="sec-sub">The teams that improve fastest close the loop between production failures and the eval dataset. Hover each node to understand the cycle.</p>

  <div class="flywheel-wrap">
    <svg class="flywheel-svg" viewBox="0 0 960 420">
      <defs>
        <marker id="arr" markerWidth="8" markerHeight="8" refX="6" refY="3" orient="auto">
          <path d="M0,0 L0,6 L8,3 z" fill="rgba(245,166,35,0.4)"/>
        </marker>
      </defs>
      <!-- curved arrows between nodes -->
      <path d="M480,85 Q720,90 820,130" stroke="rgba(245,166,35,0.25)" stroke-width="1.5" fill="none" marker-end="url(#arr)" stroke-dasharray="4,4"/>
      <path d="M855,190 Q880,280 820,310" stroke="rgba(245,166,35,0.25)" stroke-width="1.5" fill="none" marker-end="url(#arr)" stroke-dasharray="4,4"/>
      <path d="M780,360 Q620,390 480,370" stroke="rgba(245,166,35,0.25)" stroke-width="1.5" fill="none" marker-end="url(#arr)" stroke-dasharray="4,4"/>
      <path d="M420,370 Q200,380 145,330" stroke="rgba(245,166,35,0.25)" stroke-width="1.5" fill="none" marker-end="url(#arr)" stroke-dasharray="4,4"/>
      <path d="M110,280 Q95,200 145,150" stroke="rgba(245,166,35,0.25)" stroke-width="1.5" fill="none" marker-end="url(#arr)" stroke-dasharray="4,4"/>
      <path d="M210,100 Q340,70 430,85" stroke="rgba(245,166,35,0.25)" stroke-width="1.5" fill="none" marker-end="url(#arr)" stroke-dasharray="4,4"/>
    </svg>

    <div class="flywheel-center">Continuous<br>Improvement<br>Loop</div>

    <div class="flywheel-node fn-1" onclick="highlightNode(this)">
      <span class="node-num">01</span>
      Production traffic ‚Üí Online evals (1% sampling)
    </div>
    <div class="flywheel-node fn-2" onclick="highlightNode(this)">
      <span class="node-num">02</span>
      Failure cases collected & tagged
    </div>
    <div class="flywheel-node fn-3" onclick="highlightNode(this)">
      <span class="node-num">03</span>
      Test dataset expanded weekly
    </div>
    <div class="flywheel-node fn-4" onclick="highlightNode(this)">
      <span class="node-num">04</span>
      Root cause analysis via dashboard
    </div>
    <div class="flywheel-node fn-5" onclick="highlightNode(this)">
      <span class="node-num">05</span>
      Prompt / model / RAG improvements
    </div>
    <div class="flywheel-node fn-6" onclick="highlightNode(this)">
      <span class="node-num">06</span>
      Pre-deploy offline validation ‚Üí staged rollout
    </div>
  </div>
</section>

<!-- S7: CHECKLIST -->
<section id="s7">
  <div class="sec-number">07 ‚Äî BUILD YOURS</div>
  <h2>Your eval framework<br>implementation checklist</h2>
  <p class="sec-sub">Work through these in order. Each one is a concrete action. Click to mark complete ‚Äî your progress is saved below.</p>

  <div class="checklist" id="checklist">
    <!-- filled by JS -->
  </div>

  <div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:24px;margin-top:32px;">
    <div style="font-family:var(--mono);font-size:10px;color:var(--text-dim);letter-spacing:0.1em;text-transform:uppercase;margin-bottom:12px;">Completion</div>
    <div style="height:6px;background:var(--border);border-radius:3px;overflow:hidden;">
      <div id="checklist-fill" style="height:100%;background:var(--teal);border-radius:3px;width:0%;transition:width 0.5s ease;"></div>
    </div>
    <div style="display:flex;justify-content:space-between;margin-top:8px;">
      <div style="font-family:var(--mono);font-size:11px;color:var(--text-muted);" id="checklist-label">0 / 10 steps complete</div>
      <div style="font-family:var(--mono);font-size:11px;color:var(--teal);" id="checklist-pct">0%</div>
    </div>
  </div>
</section>

<footer>
  <div class="wrap">
    <div style="font-family:var(--serif);font-size:24px;margin-bottom:8px;">AI Evals ‚Äî First Principles</div>
    <div style="margin-bottom:4px;">Based on INDmoney Mind case study ¬∑ Designed for PMs building AI products</div>
    <div style="color:var(--text-dim);">The best eval framework is one you actually maintain.</div>
  </div>
</footer>

</div><!-- /wrap -->

<script>
// ---- FIRST PRINCIPLES CARDS ----
function toggleFP(card){
  const wasOpen = card.classList.contains('open');
  document.querySelectorAll('.fp-card').forEach(c=>c.classList.remove('open'));
  if(!wasOpen) card.classList.add('open');
  updateProgress();
}

// ---- PYRAMID ----
function selectRow(row){
  document.querySelectorAll('.pyramid-row').forEach(r=>r.classList.remove('selected'));
  row.classList.add('selected');
}

// ---- METRICS SIMULATOR ----
function updateMetrics(){
  const accuracy = parseFloat(document.getElementById('sl-accuracy').value);
  const compliance = parseFloat(document.getElementById('sl-compliance').value);
  const halluc = parseFloat(document.getElementById('sl-halluc').value);
  const latency = parseFloat(document.getElementById('sl-latency').value);
  const sat = parseFloat(document.getElementById('sl-sat').value);

  setValue('accuracy', accuracy+'%', accuracy<95?'crit':accuracy<98?'warn':'ok');
  setValue('compliance', compliance+'%', compliance<99.5?'crit':'ok');
  setValue('halluc', halluc+'%', halluc>5?'crit':halluc>2?'warn':'ok');
  setValue('latency', latency+'s', latency>5?'crit':latency>3?'warn':'ok');
  setValue('sat', sat+'%', sat<70?'crit':sat<80?'warn':'ok');

  document.getElementById('sv-accuracy').textContent=accuracy+'%';
  document.getElementById('sv-compliance').textContent=compliance+'%';
  document.getElementById('sv-halluc').textContent=halluc+'%';
  document.getElementById('sv-latency').textContent=latency+'s';
  document.getElementById('sv-sat').textContent=sat+'%';

  // deploy gate
  const blocked = accuracy<95 || compliance<99.5 || halluc>5;
  const warn = accuracy<98 || halluc>2 || latency>3 || sat<80;
  const gate = document.getElementById('deploy-gate');
  const icon = document.getElementById('deploy-icon');
  const text = document.getElementById('deploy-text');
  if(blocked){
    icon.textContent='‚úó'; icon.style.color='var(--red)';
    text.textContent='BLOCKED'; text.style.color='var(--red)';
  } else if(warn){
    icon.textContent='‚ö†'; icon.style.color='var(--amber)';
    text.textContent='REVIEW'; text.style.color='var(--amber)';
  } else {
    icon.textContent='‚úì'; icon.style.color='var(--teal)';
    text.textContent='CLEARED'; text.style.color='var(--teal)';
  }
}

function setValue(id, val, status){
  document.getElementById('mv-'+id).textContent=val;
  const ms = document.getElementById('ms-'+id);
  ms.className='metric-status status-'+status;
  const mc = document.getElementById('mc-'+id);
  mc.style.borderColor=status==='crit'?'var(--red)':status==='warn'?'var(--amber)':'var(--border)';
}

// ---- DATASET BARS ----
const dataset = [
  {label:'Fundamental Analysis',count:100,pct:20,color:'#F5A623',priority:'P0'},
  {label:'Compliance / Safety',count:80,pct:16,color:'#E85D75',priority:'P0'},
  {label:'Edge Cases',count:60,pct:12,color:'#E85D75',priority:'P0'},
  {label:'Technical Analysis',count:80,pct:16,color:'#F5A623',priority:'P0'},
  {label:'Adversarial Inputs',count:30,pct:6,color:'#E85D75',priority:'P0'},
  {label:'Sentiment & News',count:60,pct:12,color:'#F5A623',priority:'P1'},
  {label:'Peer Comparisons',count:50,pct:10,color:'#F5A623',priority:'P1'},
  {label:'Multi-turn Conversations',count:40,pct:8,color:'#2EC4B6',priority:'P2'},
];

function buildDataset(){
  const wrap = document.getElementById('dataset-bars');
  wrap.innerHTML = dataset.map((d,i)=>`
    <div class="ds-row" style="animation:fadeUp 0.4s ease ${i*0.06}s both;">
      <div class="ds-label">${d.label}</div>
      <div class="ds-bar-wrap">
        <div class="ds-bar" style="background:${d.color};" data-pct="${d.pct}">${d.count} cases</div>
      </div>
      <div class="ds-count">${d.count}</div>
      <div class="ds-tag"><span class="tag ${d.priority==='P0'?'tag-p0':d.priority==='P1'?'tag-p1':'tag-p2'}">${d.priority}</span></div>
    </div>
  `).join('');
  // animate bars
  setTimeout(()=>{
    document.querySelectorAll('.ds-bar').forEach(b=>{
      b.style.width=b.dataset.pct+'%';
    });
  },100);
}
buildDataset();

// ---- TABS ----
function switchTab(id){
  document.querySelectorAll('.eval-tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.eval-panel').forEach(p=>p.classList.remove('active'));
  document.getElementById('tab-'+id).classList.add('active');
  event.target.classList.add('active');
}

// ---- FLYWHEEL ----
function highlightNode(node){
  document.querySelectorAll('.flywheel-node').forEach(n=>n.style.borderColor='');
  node.style.borderColor='var(--amber)';
  node.style.color='var(--text)';
  node.style.background='var(--amber-glow)';
  setTimeout(()=>{
    node.style.borderColor='';
    node.style.color='';
    node.style.background='';
  },2000);
}

// ---- CHECKLIST ----
const checks = [
  {title:'Define "good output" before writing any prompts',desc:'Write down 5 concrete examples of perfect responses for your product. These become your anchors.'},
  {title:'Identify your top 3 failure modes',desc:'For each, ask: what is the worst thing that could happen? Rank by severity √ó probability.'},
  {title:'Set metric thresholds with business rationale',desc:'Every threshold needs a "why". 98% accuracy is meaningless without knowing what 2% wrong costs you.'},
  {title:'Build a compliance checker first',desc:'Rule-based regex for prohibited outputs. It runs on every response, costs nothing, and catches the most catastrophic failures.'},
  {title:'Create 50 "smoke test" cases before first deploy',desc:'Cover your most critical failure modes. These must pass before any deployment ‚Äî no exceptions.'},
  {title:'Set up LLM-as-judge for quality signals',desc:'Write a judge prompt for your top 2-3 subjective dimensions. Calibrate against 20 human ratings.'},
  {title:'Plan your production sampling strategy',desc:'Decide: what % of traffic will you evaluate async? How will violations trigger alerts?'},
  {title:'Define how failures feed the test dataset',desc:'Create a process: when a bad response is found, it gets added to the dataset within 1 week.'},
  {title:'Set up deployment gates and block conditions',desc:'Which metrics, at what thresholds, automatically block a deployment? Document these explicitly.'},
  {title:'Schedule quarterly dataset + threshold reviews',desc:'Metrics drift over time. Query patterns shift. Put calendar events now for the next 4 quarters.'},
];

function buildChecklist(){
  const saved = JSON.parse(localStorage.getItem('eval-checks')||'[]');
  const wrap = document.getElementById('checklist');
  wrap.innerHTML = checks.map((c,i)=>`
    <div class="check-item ${saved.includes(i)?'done':''}" onclick="toggleCheck(this,${i})">
      <div class="check-box">${saved.includes(i)?'‚úì':''}</div>
      <div>
        <div class="check-title">${i+1}. ${c.title}</div>
        <div class="check-desc">${c.desc}</div>
      </div>
    </div>
  `).join('');
  updateChecklistProgress();
}

function toggleCheck(item,i){
  item.classList.toggle('done');
  const box = item.querySelector('.check-box');
  box.textContent = item.classList.contains('done')?'‚úì':'';
  const done = [...document.querySelectorAll('.check-item.done')].map((_,idx)=>idx);
  // get actual indices
  const allItems = [...document.querySelectorAll('.check-item')];
  const doneIndices = allItems.map((el,idx)=>el.classList.contains('done')?idx:-1).filter(v=>v>=0);
  localStorage.setItem('eval-checks',JSON.stringify(doneIndices));
  updateChecklistProgress();
}

function updateChecklistProgress(){
  const total = checks.length;
  const done = document.querySelectorAll('.check-item.done').length;
  const pct = Math.round(done/total*100);
  document.getElementById('checklist-fill').style.width=pct+'%';
  document.getElementById('checklist-label').textContent=`${done} / ${total} steps complete`;
  document.getElementById('checklist-pct').textContent=`${pct}%`;
  updateProgress();
}
buildChecklist();

// ---- PROGRESS ----
function updateProgress(){
  const done = document.querySelectorAll('.check-item.done').length;
  const open = document.querySelectorAll('.fp-card.open').length;
  const total = 16;
  const pct = Math.min(100, Math.round((done*6 + open*4) / total * 10));
  document.getElementById('progress').style.width=pct+'%';
  document.getElementById('progress-label').textContent=pct+'% explored';
}

// ---- SCROLL OBSERVER ----
const sections = ['s1','s2','s3','s4','s5','s6','s7'];
const navSteps = document.querySelectorAll('.nav-step');
const obs = new IntersectionObserver((entries)=>{
  entries.forEach(e=>{
    if(e.isIntersecting){
      const idx = sections.indexOf(e.target.id);
      if(idx>=0){
        navSteps.forEach(n=>n.classList.remove('active'));
        if(navSteps[idx]) navSteps[idx].classList.add('active');
      }
    }
  });
},{threshold:0.3});
sections.forEach(id=>{
  const el = document.getElementById(id);
  if(el) obs.observe(el);
});
</script>
</body>
</html>
